# CascadeType.MERGE 가 부모는 영속상태지만 자식 엔티티가 비영속 상태일 때 생기는 문제
  
## 문제 발생 상황 설명  
부모 엔티티가 이미 영속 상태이고 자식 엔티티를 추가해야 하는 상황에서, 새로운 자식 엔티티는 아직 비영속 상태이다.   
이때 부모 엔티티의 리스트 필드에 비영속 자식 엔티티를 추가하고 부모를 저장하려고 하면 에러가 발생할 수 있다.   
왜냐하면 부모는 영속화되어 있지만 자식 엔티티는 영속화되지 않았기 때문이다.  
  
## 문제 원인 설명  
부모는 이미 영속 상태이므로 저장이 불필요하지만, 새로운 자식 엔티티는 비영속 상태이다.   
이 상태에서 부모 엔티티의 `List<자식>`에 자식을 추가하고 저장하려고 할 때 문제가 발생한다.  
JPA의 관점에서 부모와 자식 간의 연관관계가 아직 확립되지 않은 상태로 영속성이 적용되지 않기 때문이다.   
이로 인해 `parent`와 `child` 사이의 연관관계 설정이 완료되지 않아서 데이터베이스에 저장할 때 자식 엔티티의 외래 키 제약 조건을 만족하지 못하게 된다.  
  
## CascadeType.MERGE 에 대해서 "부모 영속, 자식 비영속 상태일 때 Cascade"  
`CascadeType.MERGE`는 부모 엔티티가 영속 상태일 때,   
자식 엔티티가 비영속 상태인 경우 자동으로 자식 엔티티도 병합(merge)하여 영속화한다.  
이를 통해 부모 엔티티의 상태가 변경되거나 자식 엔티티가 추가될 때 
`parentRepository.save(parent)`만으로도 부모와 함께 자식 엔티티도 자동으로 영속화된다.  
  
즉, `MERGE`가 적용된 상태에서는 부모 엔티티의 변경 또는 자식 엔티티의 추가가 발생하면,  
자식 엔티티를 영속화시켜 부모와의 연관관계를 데이터베이스에 반영할 수 있게 된다.  
  
## 총 정리
- **문제 요약**: 부모는 영속 상태이지만 새로운 자식 엔티티는 비영속 상태일 때, 자식 엔티티를 부모에 추가하고 저장하면 오류가 발생한다.
- **원인 분석**: 부모와 자식 간의 연관관계 설정이 미완료 상태에서 자식을 저장하려 할 때, 자식 엔티티의 외래 키 제약 조건을 만족시키지 못해서 발생하는 문제이다.
- **해결책**: `CascadeType.MERGE`를 사용하면 부모가 영속화될 때 비영속 상태인 자식 엔티티도 병합되어 함께 영속화된다. 즉, 부모와 자식 간의 연관관계를 제대로 반영할 수 있게 된다.
- **TIL 결론**: 부모 엔티티가 영속 상태이고 새로운 자식 엔티티를 추가해야 할 때, 자식이 영속 상태로 병합될 수 있도록 `CascadeType.MERGE`를 사용해야 한다. 그렇지 않으면 부모는 영속화되어도 자식이 영속화되지 않아 문제가 발생할 수 있다.
