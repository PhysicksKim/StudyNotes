# 선행 지식 
- 페이징 기본 개념  
- 오프셋 페이징 + 문제점    
- 커서 페이징 + 문제점

  
---

# 페이징 기본 개념 
커뮤니티 사이트의 게시판들을 보면 흔하게 1 2 3 4 ... 같은 게시판 페이지 버튼을 볼 수 있다.    
이를 페이징 이라고 하고, 생각보다 DB 쿼리 효율 측면에서 중요한 문제로 다뤄진다.   
  
# 오프셋 페이징  
    
단순히 생각하면 4페이지인 경우 1~10 11~20 21~30 31~40 이므로  
"최신 순으로 31번째 부터 40번째 까지 가져와 주세요" 라고 생각할 수 있다.  
이렇게 하면 최신순으로 게시물을 조회한 다음 40개를 주르륵 찾아내고, 31~40 번 데이터만 쏙 뽑아오는 식으로 동작한다.  
    
### 문제점  
문제는 게시글이 많아졌을 때 발생한다. 

#### 시나리오 
만약 10만개의 게시글이 있고 9만번째 부터 10개의 글을 찾아온다고 해보자.  
그러면 요청이 발생할 때마다 DB에서 게시글을 매 번 9만개씩 계속 가져오게 된다.  
얼핏 생각해도 문제가 심각해질 수 있다고 여겨진다.  

#### 시나리오 plus
앞선 시나리오에 좀 더 끔찍한 상황을 추가해보자.  
URL 에 query parameter 로 <code>?page=9000</code> 라고 한 다음  
해당 url 을 복사해서 다른 사람에게 공유했다고 해보자.  

그리고 이제 그 url 링크를 다른 사람들이 클릭할 때마다  
단지 페이지 버튼 만들겠다고 9만 개의 데이터 조회 연산만큼 매 번 낭비하게 된다.   
이로 인해서 큰 성능 문제를 야기할 수 있다.  
  
## 오프셋 페이징의 추가적 특성  
오프셋 페이징에는 또 추가적인 특징이 있다.    
예를 들어 2 page 의 첫 번째 글 (11번 글)을 보고 있다고 해보자.   
그리고 사용자가 3 page 버튼을 눌렀다.  
그런데 그 사이에 게시글 10개가 생성됐다면, 앞서 사용자가 본 2page 와 동일한 10개의 글을 보게 된다.  
  
이러한 특징의 장단점은 바로 이어서 커서 페이징 설명 후에 알아보도록 보도록 하자.   
  
<br><br>  
  
# 커서 페이징  
앞서 본 오프셋 페이징의 단점을 보완하고자 나온 게 커서 페이징이다.  
커서 페이징은 "마지막으로 보여준 데이터 id 가져와서, 해당 데이터 부터 그 다음 10개를 보여줘" 라는 식으로 동작한다.  
이렇게 하면 앞서 본 page 9000 문제는 해결된다.  
  
### 오프셋 페이징 특성의 장단점  
이 문제는 사이트의 목적에 따라서 장점 또는 단점이 될 수 있다.  
글 생성이 느린 게시판 같은 경우 "그 사이에 글이 10개가 써졌구나" 라고 사용자가 자연스럽게 인식할 수 있기 때문에, 오히려 이러한 점은 장점이 된다.  
  
반면 "다음 게시글" 을 얻고 싶은 경우 오프셋 페이징 특성은 부적절하다.     
예를 들어 숏츠나 인스타 같이 연속으로 "다음 10개" 를 로딩해야 하는 경우 오프셋 페이징을 사용하면 문제가 될 수 있다.  
앞선 글이나 영상을 보는 사이에 새로운 글 1개만 생기더라도   
사용자는 다음 글 보기를 눌렀는데 앞서 본 글을 또 보여주게 되는 끔찍한 사용자 경험을 만들 수 있다.   
그래서 이러한 경우 커서 페이징을 사용해야 한다.  
  
## 커서 페이징 장점   
커서 페이징은 오프셋 페이징과 다르게 버리는 데이터가 없다.  
id를 기반으로 찾아 들어가기 떄문에, 인덱스가 동작해서 곧바로 찾아 들어갈 수 있다.  
100,000번째에 위치한 데이터 일지라도, 상수 시간 복잡도 속도로 찾아 들어간다.  
  
## 커서 페이징으로 오프셋 페이징 특성 해결  
id 기반으로 동작하기 때문에 다음 데이터, 이전 데이터를 정확히 가져올 수 있다.  
- 오프셋 방식 : "최신순 21번째" 에서 \[다음] 을 누르면 "최신순 22번째" 로 이동  
- 커서 방식 : "id 310" 에서 \[다음] 을 누르면 "id 309" 로 이동   
오프셋 방식은 최신순으로 따지기 때문에 글 1개가 딱 생기면, 밀려나서 문제가 생긴다.
반면 커서 방식은 이런 문제가 완전히 해결된다.

<br><br>  
  
# 전통적인 게시판에서 문제  
우리가 일반적으로 아는 게시판은 페이지 버튼 1 2 3 4 5 ... 이 있다.  
  
이건 **커서 페이징으론 구현 못한다**.    
물론 1차적으로 사용자의 열람 입장에서는 커서 페이징이 가능하다.        
하지만 현재 페이지가 몇 페이지인지 상태를 유지하고(쿼리 파라미터 등) url 을 다른 사용자에게 공유하려 한다면  
커서 페이징만 사용해서는 할 수 없다.  
   
> ### 왜 오프셋 페이징 긴 설명
> 커서 페이징 만으로는 1 2 3 4 5 페이지 버튼을 왜 만들 수 없는지 알아보자.
>   
> 이 부분 설명은 디테일한 내용이라 스킵해도 된다.
> 다만 직접 게시판을 만들때 커서 페이징과 오프셋 페이징을 고민한다면 많이 도움될 시나리오 예시다.
> 머리가 복잡해질 수 있으니, 여기서 부터 차근히 천천히 읽도록 하자.   
>     
> ### 현재 시나리오 상황        
> 11 12 13 \[14] 15 16 17 이렇게 페이지 버튼이 있고 현재 14 페이지라 해보자.    
> 현재 사용자는 페이지당 10개 / 14 페이지 3번째 글을 읽고 있다.   
> 사용자는 해당 글 url 을 복사해서 친구에게 공유했다.   
>
> ### url 공유 링크 클릭 상황  
> url 에는 쿼리 파라미터로 ?page=14&seq=3&postId=203 가 담겨있다 (page : 현재 페이지, seq : 3번째 글)   
> 그런데 친구가 1시간 뒤에 url 을 클릭해서, 그 사이에 글이 30개나 더 생겼다.   
>
> ### url 클릭 결과  
> 이러면 postId 로 글 조회는 올바르게 되겠지만,    
> 이제는 그 글이 더이상 14페이지 3번째 글이 아니다.   
> 1시간 사이에 글 30개가 더 생겨서 페이지가 밀려났기 때문이다.  
>    
> 따라서 결국에는 url 로 공유해도 페이지 상황을 살릴 수는 없다.   
>
> ### 핵심 : "더 이상 14페이지가 아니다"     
> 쿼리 파라미터에 해당 페이지에 모든 게시글을 담아두는 식으로 공유할 수도 있다.   
> 이러면 현재 페이지의 글 10개와 다음페이지, 이전페이지가 동작할 수 있다.   
> 하지만, 그 글은 더이상 14페이지 3번째 글은 아니다.   
>    
> 이러한 점을 종합해볼 때  
> 결국 오직 커서 페이징만 사용한다면, 전통적인 게시판 페이지 버튼을 보여주기에는 부적절하다.

---
  
# 해결 방법  
   
### 오프셋 페이징 + 커서 페이징 혼합 사용   
   
페이지 10000 이하는 오프셋 페이징 사용   
페이지 10000 초과는 커서 페이징 사용하고 페이지 버튼을 사용할 수 없도록 한다.  
   
### 이점  
오프셋 페이징을 통한 페이지 버튼이 있으면 사용자가 더 편해진다.  
그래서 성능상 문제 없을법한 정도만큼은 오프셋 페이징과 페이지 버튼을 사용해서 사용자 경험을 좋게 할 수 있다.  
(여기서 10,000 페이지로 예시를 들었지만, 사이트 마다 달라질 수 있다)  
    
그리고 오래된 글 같은 경우에는    
앞뒤로 게시글 n개 보여주도록 하면    
페이지 버튼은 제공할 수 없지만   
적어도 다음 페이지 보기는 동작하도록 할 수 있다.  
