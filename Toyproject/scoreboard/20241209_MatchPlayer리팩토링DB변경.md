# 엔티티 변경 시 이전 데이터 마이그레이션 전략을 잘 세우자  

---

# 변경된 이유와 내용 

### 이전 구조  
이전에는 경기 라인업 엔티티 연관관계가 아래와 같은 구조였다  
```
Fixture - StartLineup - StartPlayer - Player  
```
각 경기 `Fixture` 엔티티는 라인업 정보를 저장하기 위한 Home/Away 팀별 `StartLineup` 엔티티가 있고  
Grid 정보와 후보/선발 정보를 담기 위한 `StartPlayer` 엔티티가 중간에 들어가 있고  
`StartPlayer`-`Player` 연관관계를 맺고 있었다.  
  
### 변경 구조  
```
Fixture - MatchLineup - MatchPlayer - Player  
```
사실 구조 자체는 동일하다. 다만 내용이 다른데  
이전에는 다른 경기 데이터들은 곧바로 Player 를 연관관계 맺도록 설정해뒀었다.  
예를 들면  
```
Fixture - StartLineup - StartPlayer - Player
 ├ FixtureEvent - Player
 ⎣ PlayerStatistics - Player
```
이와 같은 구조였다.

그런데 여기서 `id=null` 인 `미등록선수(unregistered player)` 가 등장하게 되는데  
유스 선수나 무명 선수의 경우 데이터를 제공하는 측에서 관리되는 선수가 아니라서 그런지 id 가 없는채로 제공됐다.  
id=null 이니 FixtureEvent, PlayerStatistics 에 연관된 선수가 누구인지 기록하기 어려워졌다.  
   
따라서 `Player` 를 의존하던 구조를 전부 `StartPlayer` 를 의존해서 감싸도록 만들었고  
이제 Start 라는 접두어보다 Match 라는 접두어가 적절하다고 판단하여   
이름과 함께 엔티티 연관 구조도 변경했다.  
그리고 `MatchPlayer` 에서 `unregistered___` 같은 필드를 통해 이름과 임시id 등을 통해 식별할 수 있도록 변경했다.  

최종적으로 아래와 같은 구조로 바뀌었다  

```
Fixture - MatchPlayer - MatchPlayer -(nullable)- Player
 ├ FixtureEvent - MatchPlayer
 ⎣ PlayerStatistics - MatchPlayer
```

<br>  
  
# 그런데, 이전 데이터 마이그레이션을 고려안했다  
  
이전 데이터들을 변경된 구조로 마이그레이션 하는 과정을 거쳐야 한다.      
이걸 고려 안하고 그냥 업데이트 해버리니 에러가 펑펑 터졌다.  
  
> 사실 생각은 하고 있었는데 딱히 이전 경기 데이터들이 현재 내 앱에서는 중요하지 않아서 그냥 날려버리기로 했다.
> 어차피 이전 경기 데이터들이 필요하다면 다시 AvailableFixture 를 등록해서 job 이 동작하도록 하면 되니까  
  
만약 마이그레이션을 고려했다면 아래와 같이 점진적인 업데이트를 해야 했을 것이다  

1. 이전 버전 엔티티를 놔두고 FK 조건등에 문제가 생길 수 있는 제약조건을 풀어둔다.  
2. 새로운 버전 엔티티를 설계하고 당장에는 새 버전 엔티티를 직접 사용하진 않고 테이블만 존재하도록 만든다.  
3. 이전 데이터들을 새로운 버전 엔티티에 변환하여 저장해두는 작업을 수행하는 장치를 만들어둔다. 즉, 코드로 `마이그레이션 서비스` 를 만든다. 
4. `마이그레이션 서비스` 가 추가된 버전을 반영해서 라이브 서버에 `이전 방식 엔티티` 를 사용하면서, 다음 버전에 사용될 `새로운 버전 엔티티` 방식으로도 저장되도록 한다.
5. `새로운 엔티티 버전` 을 업데이트 한다. 이 떄에는 `이전 방식 엔티티` 를 완전히 배제하고 내부 코드들이 모두 `새로운 버전 엔티티`를 사용하는 구조로 돌아간다
6. 정상적으로 동작한다면 이제 `이전 방식 엔티티` 흔적들을 완전히 제거해 나간다
  
<br>  

이전에 존재하던 데이터들을 잃지 않고 서비스도 다운타임을 최소화 하며 안정적으로 동작하도록 하려면  
이렇게 복잡하게 마이그레이션 전략을 수립하면서 업데이트 해나가야 한다  
  
고객이 생산해낸 정보(ex. 주문기록, 거래기록 등)가 소실되지 않아야 한다면   
이 같은 마이그레이션 전략이 매우 중요할 것 같다.  

  
