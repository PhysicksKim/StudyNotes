# 클릭 한번에 { stomp 연결 + Code발급채널Sub + Code발급수신 }
  
```
1) 객체 생성 및 stomp 연결 
2) onconnect를 사용해 코드발급채널 subscribe 
3) subscribe 완료 시 코드발급요청 (/app/remote.issuecode) 보내고, 앞서 subscribe 한 채널로 코드를 발급받음
```

이 과정이 별로 어려워 보이지 않겠지만, 문제가 있다.  
  
 - 과정 2) 에서 subscribe 성공 여부를 알 수 없다. 서버는 sub 완료후 완료 메세지를 보내지 않는다
 - 과정 3) 에서 코드 발급 요청이 정상 전달 됐는지, 지연되는 중인지 알 수 없다.   

이에 대한 고민을 기록했다.  

<br><br>  

# 원클릭 코드 발급 시나리오의 어려움
  
클릭 한번에 stomp 연결과 원격 코드를 발급받도록 하고싶다.  
사용자 경험이 확실히 향상되기 때문이다.  
  
하지만 앞서 말한 대로 subscribe 완료 여부를 알 수 없기 때문에  
"발급한 코드를 수신하는 채널 subscribe 완료 후" 라는 게 불가능 하다.  
  
따라서 "1) 단순히 딜레이를 주는 방법" 이나 "2) 반복적으로 발급 요청을 보내는 방법" 중 하나를 채택해야 한다.  
  
<br><br>  
  
# 두 가지 방법  

subscribe 완료 여부를 알 수 없다.   
따라서 어떻게 sub 완료 여부를 모르고도 코드 발급 요청을 보낼 수 있도록 할지 생각해야 한다.  
  
> 참고로 웹 소켓 연결에 실패하는 시나리오는 이 글과 상관없다.     
> Stomp OnConnect 를 사용하면 "웹 소켓 연결 완료 후 동작" 을 지정할 수 있기 때문이다.     
> 이 글에서는 "Stomp Channel Subscribe 완료 후 동작" 을 지정할 수 없다는 문제에 대한 논의를 다룬다는 점을 명료히 상기시키고 간다.  
  
<br><br>  
  
## 1) 단순히 조금 긴 딜레이 주기  
   
sub 요청을 보낸 후 조금 길게 딜레이를 주고 코드 발급 요청을 보내는 방식.  
sub 이 완료될 시간을 충분히 준 뒤에 코드 발급 요청을 보낸다.  
  
이 경우 서버 부하가 줄어든다는 장점이 있고, 서버에서 중복된 발급 처리를 필터링 하지 않아도 된다는 장점이 있다.   
   
다만 단점은 아주 빠르게(0.2초) sub 가 완료되어 코드 발급이 가능할 지라도,  
강제적으로 사용자는 미리 세팅된 긴 딜레이을 기다릴 수 밖에 없다.    
  
> 네트워크 환경과 서버 상태에 따라서 코드 발급 요청이 오래 딜레이될 수 있다.  
> 따라서 원클릭 코드발급 실패 횟수를 카운트 하면서 점차 딜레이를 늘려나가는 전략을 추가로 사용할 수 있다.  
  
<br><br>  

## 2) 짧은 주기로 발급 요청 반복  
  
웹 소켓 연결 후 sub 이후 짧은 딜레이(0.3초)로 코드 발급 요청을 반복하도록 한다.  
  
장점은 사용자가 빠른 시간안에 코드 발급을 완료할 수 있다는 점이다.   
사용자들은 1초씩이나 기다릴 여유가 없기 때문에, 이 방식은 확실히 사용자 경험을 향상시켜 준다.  
  
단점은 서버에서는 "중복된 발급 요청 처리"를 해결해야 하고,  
클라이언트에서는 "이 발급 요청이 하나의 _**맥락**_ 에서 진행됐는지 구분할 방법" 을 제공해야 한다는 점이다.  

> ### 여기서, 맥락(context) 이란
> "같은 맥락" 또는 "하나의 맥락" 이라는 말은,
> 코드 발급 요청을 반복적으로 시도 중인 건지
> 아니면 코드 발급 요청 후에, 사용자가 빠르게 재발급을 시도한 것인지를
> 구분하기 위한 말이다.
>    
> 코드 발급 시도를 순서대로 ( a, b, c, d, ... ) 시도라고 해보자.
> 여기서 a,b,c 시도는 처음으로 코드 발급을 하기 위한 요청이고
> d, e 시도는 코드 재발급 요청이라고 하자.
> 이 때 a b c d e 중 어떤 코드 발급 시도가 같은 시도 묶음인지를 구분할 방법이 필요하다.  
> 따라서 "코드 발급 맥락" 이 동일한지 구분해야 한다는 뜻에서 "맥락" 이라는 단어를 썼다.   
  
### - 중복된 발급 요청 처리  
클라이언트가 계속 코드를 발급하는 명령을 보내는 중인건지 아니면 독립된 다른 코드 발급 요청을 빠르게 보낸 것인지(재발급 요청) 구분할 전략이 필요하다.   
서버는 하나의 맥락에서 보낸 코드 발급요청의 경우, 최초 발급 다음 뒤에 요청은 무시하도록 해야한다.
  
### - 발급 요청 맥락 구분  
클라이언트가 맥락을 구분할 책임을 지도록 하면 된다. 클라이언트는 맥락에 따라서 유일한 코드를 생성하고(ex. UUID 또는 요청 시간등 사용), 이를 발급 요청에 같이 보내면 된다.  
서버는 해당 맥락을 캐시에 담아두도록 하고, 해당 맥락에 대해서 발급 이력이 있으면 코드 발급을 무시하도록 하면 된다.
재발급시에는 맥락 코드가 달라지는 게 핵심이다.   
  
<br><br>  

# 내 생각에 핵심은 맥락 구분 로직이다  
맥락 구분 구현이 어려워 진다면 첫 번째 방식이 더 좋고  
맥락 구분 구현이 쉽다면 두 번째 방식이 더 좋다.  
  
따라서 우선 맥락 구분 기능부터 설계하고 테스트 해보는 게 좋을 것 같다.  
