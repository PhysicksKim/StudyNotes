# CH4 아키텍처  

<br><br>

# 4.1 MySQL 엔진 아키텍처

![image](https://github.com/PhysicksKim/TIL/assets/101965836/b793546a-5e34-4af6-b79b-c62c5325f420)  
  
MySQL은 전체 구조를 간략하게 설명하면 위와 같다  
  
여기서 핵심은 엔진이 크게 2단계로 나뉘어 있다는 점이다.    
  
- MySQL 엔진 : 프로그래밍 API 와 밀접하게 연관된 동작을 수행    
- 스토리지 엔진 : 데이터 저장소와 밀접하게 연관된 동작을 수행  
  
<br>  
  
## 4.1.2 MySQL 스레딩 구조  
포그라운드 스레드 + 백그라운드 스레드  

### 포그라운드 스레드  
MySQL 서버에 접속된 클라이언트 사용자 요청 쿼리를 처리한다  
커넥션이 종료되면 해당 스레드는 스레드 캐시(Thread Cache)로 되돌아간다.  
스레드 캐시에는 일정 개수 이상의 스레드가 대기중에 있다.  
  
### 백그라운드 스레드   
InnoDB 에서는 여러 작업이 백그라운드로 처리된다.    
로그를 기록, 버퍼 사용해서 데이터를 디스크에 쓰는 작업, 데드락 모니터링 등을 백그라운드로 처리한다.   
  
쓰기 작업은 버퍼를 사용하고 백그라운드 스레드에서 일어난다.  
반대로 읽기 작업은 백그라운드로 넘기지 않고 포그라운드 스레드가 곧바로 처리한다  
  
<br>  
  
## 4.1.3 메모리 할당 및 사용 구조  

글로벌하게 중심이 되는 MySQL 서버 하나가 딱 있고  
각 Connection 마다 할당될 스레드가 있고 각기 있을 것이다.  
  
이에 따라서 메모리 할당도  
Global Memory 영역 하나 딱 있고  
Session(Connection) Memory 영역이 제각각 있게 된다.  
  
### Global Memory 영역  
스레드 수와 무관하게 하나의 메모리 공간만 할당  
> - 그냥 대충 이런 것들이 있다    
> Inno DB 버퍼 풀 , MyISAM 키 캐시, 바이너리 로그 버퍼, 리두 로그 버퍼, 테이블 캐시    
  
### Session Memory 영역  
커넥션(Connection) 메모리 영역 이라고도 한다   
클라이언트 스레드가 쿼리를 처리하는 데 사용하는 메모리 영역이다.    
  
스레드별로 메모리가 독립적으로 할당되며    
절대로 공유되어 사용되면 안된다.   
   
> Session Memory 영역을 너무 크게 잡아버리면 메모리 부족으로 멈출 수 있다.

> 정렬 버퍼, 조인 버퍼, 바이너리 로그 캐시, 네트워크 버퍼 등이 있다  
  
<br>  
  
## 4.1.4 플러그인 스토리지 엔진 모델  
    
MySQL 의 독특한 구조 중 하나인 플러그인 모델      
플러그인을 바꿔 끼워 넣거나 추가하는 식으로 MySQL에 기능을 추가할 수 있다는 장점이 있다.    
    
이 중에서 스토리지 엔진은    
디스크 읽기 쓰기를 처리하는 역할을 한다.     
  
책에는 스토리지 엔진이 어떤 것들이 있고 플러그인들을 어떻게 확인하는지 등 이야기를 하는데  
거두절미하고  
그냥 인증, 전문 검색(Full Text Search), 쿼리 재작성, 비밀번호 검증, 커넥션 제어 등과 같은 유용한 플러그인들을 입맛에 따라 도입해서 사용할 수 있다  
  
<br>  
  
## 4.1.5 컴포넌트  
  
컴포넌트 아키텍처는 기존 플러그인 구조의 단점을 해결하고자 나온 것이다. MySQL 8.0에 나왔다  
  
### 단점  
1. Plugin - MySQL 서버 Interface 끼리만 통신 가능. 플러그인 간의 통신 불가
2. Plugin이 직접 MySQL 서버의 변수와 함수를 호출 하므로, 캡슐화 X 라서 안전하지 않음
3. Plugin 끼리 Dependency 를 설정할 수 없어서 초기화 어려움
  
> MySQL 8.0 부터는 비밀번호 검증 기능이 컴포넌트 방식으로 바뀌었다  
  
<br>    
  
## 4.1.6 쿼리 실행 구조  
    
1. 쿼리 파서 : 쿼리 문장을 토큰으로 분리하고, 트리 구조로 만들어냄. 이 과정에서 기본 문법 오류를 발견.         
2. 전처리기 : 쿼리 파서가 만든 트리를 기반으로, 테이블 이름, 칼럼 이름, 내장 함수 같은 것에 맵핑하면서 존재 여부와 접근 권한을 확인한다. 없는 함수나 테이블,칼럼 이름을 여기서 걸러낸다.        
3. 옵티마이저 : 쿼리 문장을 더 빠르게 처리할 수 있도록 최적화해주는 과정. 반대로 개발자는 옵티마이저가 잘 최적화 할 수 있도록 어떻게 유도할지 알아야 한다.      
4. 실행 엔진 : 앞서 만들어진 실행 계획에 따라서 작업을 처리하기 위해 핸들러(스토리지 엔진)에게 요청을 보내서 처리함.    
5. 핸들러(스토리지 엔진) : 디스크에 데이터를 읽고 쓰기 하는 작업을 처리한다.  
  
<br>  
  
## 4.1.7 복제

## 4.1.8 쿼리 캐시  

## 4.1.9 스레드 풀  

## 4.1.10 트랜잭션 지원 메타데이터  

<br><br>  
  
# 4.2 스토리지 엔진 아키텍처  


  

