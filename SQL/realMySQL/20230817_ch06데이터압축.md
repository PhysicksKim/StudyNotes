# CH06 데이터 압축  
  
DB는 대용량 데이터를 처리하므로   
속도 측면에서도 데이터 압축이 중요하다  
  
- 쿼리 처리시 데이터 페이지를 불러오기
- 백업
- 복구
- 저장 공간 비용문제

위와 같은 측면에서 DBMS들은 데이터 압축을 기본적으로 제공한다.  
  
MySQL 에서는   
  
1. 테이블 압축
2. 페이지 압축
  
두 가지를 제공한다.  
  
<br><br><br>  

# 6.1 페이지 압축  
  
![image](https://github.com/PhysicksKim/TIL/assets/101965836/4dd2a857-91ae-4676-8f7d-d58154ffad34)  
  
MySQL -> 디스크  할 때 압축 하고  
MySQL \<- 디스크  할 때 압축해제 한다   

> #### 페이지 압축을 Transparent Page Compression 라고 하는 이유  
> MySQL 서버 관점에서는 항상 압축 해제된 상태로 페이지를 관리하므로  
> 압축 여부와 관계없이 **투명하게 작동** 한다고 해서 Transparent 라고 한다.
   
<br>
   
## 문제점    
   
MySQL 에서 페이지를 16KB 단위로 다룬다.    
근데 압축하면 16KB -> ? KB 가 된다.  
압축 후 크기가 어떨지 알 수 없다.  
  
<br>  
  
## 해결 방안 - 펀치홀  
    
![image](https://github.com/PhysicksKim/TIL/assets/101965836/1a64f0c4-5a36-443b-8146-de047dd90d47)  

압축 후 9KB 라고 가정하자  
그러면 나머지 16KB - 9KB = 7KB 는 빈 공간으로 둬서 16KB로 맞춘다음 디스크에 쓴다  
이후 OS나 H/W가 제공하는 펀치홀 기능을 통해서  
7KB 빈공간을 제거해주면 된다.  
  
> 빈 뚫린 공간을 만든다 해서 펀치홀(Punch Hole) 이라고 한다.  
  
<br>  

## 한계 - 펀치홀 지원 필요  
페이지 압축은 위와 같은 펀치홀 기능을 OS 와 H/W 에서 지원해야 하므로 한계가 있다.  
  
따라서 실제로는 페이지 압축은 많이 사용되지 않는다.  
  
<br><br><br>  

# 6.2 테이블 압축   
  
테이블 압축은 운영체제나 하드웨어에 대한 제약 없이 사용할 수 있어서 활용도가 높지만 단점도 확실히 있다.  
  
1. 버퍼 풀 공간 활용률이 낮음
2. 쿼리 처리 성능이 낮음
3. 빈번한 데이터 변경 시 압축률이 떨어짐
  
<br>  

## 6.2.1 압축 테이블 
테이블 압축을 사용하려면 테이블 생성 과정에서 별도로 설정을 해줘야 하고,      
<code>KEY_BLOCK_SIZE</code> 라는 시스템 변수를 사용한다.  

### 압축 테이블 생성법 1
  
```SQL
CREATE TABLE compressed_table (
  c1 INT PRIMARY KEY
)
ROW_FORMAT=COMPRESSED
KEY_BLOCK_SIZE=8;
```  
    
<code>ROW_FORMAT=COMPRESSED</code> 를 명시해서 압축 옵션을 명시적으로 설정해준다.    
   
<br>  
  
### 압축 테이블 생성법 2
  
```SQL
CREATE TABLE compressed_table (
  c1 INT PRIMARY KEY
)
KEY_BLOCK_SIZE=8;
```

<code>KEY_BLOCK_SIZE=8;</code> 가 적혀있는 것을 보고  
MySQL이 "압축 테이블 생성이구나"를 파악하여 <code>ROW_FORMAT=COMPRESSED</code>를 자동으로 추가해준다  
  
<br>

## KEY_BLOCK_SIZE : 압축된 페이지 크기 목표치  
  
예를 들어 페이지가 16KB 라면  
KEY_BLOCK_SIZE 는 4KB, 8KB 로 설정할 수 있다.  
  
만약 8KB 로 설정했다고 하면  
16KB 를 압축해서 8KB 이하가 될 때까지 페이지를 나눠서 압축을 시도한다.  
  
### 예시  

```
KEY_BLOCK_SIZE=8
```

```
시행 1)  
16KB 압축 -> 12KB  
  => 8KB 를 넘으므로 페이지를 나눔

시행 2)
16KB 페이지를 나눔 (page split)   
  => 페이지1 8KB | 페이지2 8KB

페이지1 8KB 압축 -> 7KB
페이지2 8KB 압축 -> 5KB
  => 둘 다 8KB 이하이므로 저장 가능
```

<br>  

## 6.2.2 KEY_BLOCK_SIZE 결정  
테이블 압축에서 가장 중요한 부분이다.  
데이터마다 압축률이 다르기 때문에 실제 데이터를 토대로 테스트해보고  
압축 실패율이 3~5% 미만으로 나오도록 설정해주는 게 좋다.  
  
> ### 압축 실패율   
> 페이지 압축 결과가 KEY_BLOCK_SIZE 보다 커서 page split 이 발생하는 비율
> page split이 뭔지는 앞서 6.2.1 에서 KEY_BLOCK_SIZE 예시를 보면 됨  
  
<br>  
  
압축 실패율이 주된 판단 기준인 이유가  
split 이 자주 일어난다면 그만큼 연산 자원을 많이 사용하여 성능이 떨어지기 때문이다.  
  
그리고 압축 알고리즘이 많은 CPU 자원을 소모한다는 점을 알아두자.  
  
<br><br>  

## 6.2.3 압축 페이지의 버퍼 풀 적재  
  
버퍼 풀에는 "압축 된 페이지" "압축 안 된 페이지" 둘 다 적재된다.  

이렇게 둘 다 적재하는 이유는  
메모리 공간을 많이 쓴다는 단점이 생기지만, 반대로 장점이 크기 때문이다.     
  
---  
  
- 압축 된 페이지 적재 장점    
버퍼 풀(메모리)에 적재해둔 덕에 디스크 I/O 줄이면서도 메모리 적게 쓸 수 있음     
  
- 압축 해제 된 페이지 적재 장점   
페이지 읽기/쓰기에 곧바로 사용할 수 있음(압축 해제 과정 미리 해둔 개념)   
  
---  
  
<br>  
  
### 비율은 어떻게? - ( 압축 해제 페이지 / 압축 페이지 )
  
InnoDB 엔진에서는 (압축 해제 page / 압축 page) 비율을 Adaptive 하게 조절한다  
    
- CPU 사용량 🔼 (압축 해제 page) 비율 🔼
> 압축 page 비율이 높다면 메모리는 적게 쓰면서 더 많은 page를 메모리에 올려둘 수 있다.  
> 하지만 압축 - 압축해제 과정에서 CPU 자원을 많이 소모하게 된다.    
> 따라서 대신 **메모리를 더 많이 쓰고 CPU 자원을 적게 쓰기 위해서** 압축 해제 page 비율을 늘린다.  
   
- Disk IO 🔼 (압축 page) 비율 🔼   
> Disk IO 비율이 높다는 말은, 버퍼 풀(메모리)에서 알맞은 페이지를 찾지 못했다는 말이다.  
> 이 경우 버퍼 풀에 더 많은 페이지를 올려놓는 게 Disk IO 를 줄일 수 있는 방법이다.  
> 따라서 적은 메모리로 가능한한 많은 페이지를 버퍼 풀(메모리)올려두면 Disk IO를 줄일 수 있다.
> 그러므로 압축 page 비율을 올린다면 **메모리 공간을 더 쓰면서 Disk IO를 줄일 수 있다.**  
